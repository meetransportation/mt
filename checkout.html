<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Meetransportation</title>
    <link rel="icon" href="./img/icon_favicon_meetax_1_2048x2048.png" type="image/png" sizes="any">
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- International Telephone Input -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #5cc528;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f9f9f9;
            background: linear-gradient(rgba(44, 62, 80, 0.8), rgba(44, 62, 80, 0.8)), url(./img/background_1.jpg);
            background-size: cover;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
        }

        .checkout-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            flex-direction: row;
            margin: 2rem 2rem;
        }

        .form-section {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #orderForm {
            padding: 1rem 2rem;
        }

        .order-summary {
            width: 30%;
            min-width: 450px;
            background: white;
            padding: 0rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            align-self: flex-start;
            top: 2rem;
            display: inline-flex;
            flex-direction: column;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
        }

        h3 {
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 14px;
            background: #f3f3f3;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-direction: row;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            text-align: center;
            margin-top: 1rem;
        }

        .btn:hover {
            background-color: #3ba709;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background-color: var(--secondary);
            color: white;
        }

.order-item {
    display: flex
;
    margin-bottom: 0.5rem;
    flex-direction: column;
    align-items: center;
    border-radius: 15px;
    box-shadow: 0px 0px 0px 1px rgb(221 221 221);
    background: #f3f3f3;
    padding: 0.2rem 1rem;
}

        .order-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 5px;
        }

        .order-details {
            flex: 1;
            width: 100%;
        }

        .order-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .order-price {
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            margin-top: 0.5rem;
            font-size: 1.5rem;
        }

.order-total {
    padding-top: 0.5rem;
    border-top: 2px solid #eee;
    font-size: 1.4rem;
    font-weight: 600;
    display: flex
;
    justify-content: space-between;
}

#box-counter {
    display: flex
;
    align-items: center;
    margin-bottom: 7px;
    justify-content: center;
}

#box-counter button {
    background: #5fc62b;
    color: white;
    width: 25px;
    height: 25px;
    cursor: pointer;
    border-radius: 15px;
}

        .payment-options {
            margin-top: 0.5rem;
            padding-top: 1rem;
            border-top: 2px solid #eee;
        }

        .payment-option {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option:hover {
            border-color: var(--secondary);
        }

        .payment-option input {
            margin-right: 1rem;
        }

        .payment-icon {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .payment-label {
            flex: 1;
        }

        .payment-selected {
            border-color: var(--secondary);
            background-color: rgba(92, 197, 40, 0.1);
        }

        .success-message {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 2rem;
        }

        .success-icon {
            font-size: 3rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        /* Estilos para promociones */
        .promo-summary .order-title {
            font-size: 1.5rem;
            color: var(--secondary);
        }

        .promo-summary .order-price {
            font-size: 1.8rem;
            color: #FFC107;
        }

        .order-price {
            font-weight: 600;
            color: var(--secondary);
            width: 100%;
            margin-top: 0.5rem;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .order-tax {
            width: 100%;
            font-size: 0.9rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 0.2rem;
            padding-top: 0.2rem;
        }

        .Modal-Title {
            width: 100%;
            background: rgb(231 231 231);
            min-height: 40px;
            pointer-events: none;
            border-bottom: 1px solid rgb(221 221 221);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px 10px 0px 0px;
        }

        .Modal-Body {
            background: rgba(255, 255, 255, 0);
            flex: 1;
            padding: 1rem;
            overflow: auto;
            max-height: calc(100vh - 100px);
        }

        /* Estilos para Stripe */
        #stripeCardElement {
            display: none;
            margin: 1.5rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .StripeElement {
            box-sizing: border-box;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 14px;
            background-color: #f3f3f3;
            transition: border-color 0.3s;
        }

        .StripeElement--focus {
            border-color: var(--secondary);
        }

        .StripeElement--invalid {
            border-color: var(--accent);
        }

        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }

        #card-errors {
            color: var(--accent);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        @media (max-width: 940px) {
            .order-summary {
                min-width: 360px;
            }
        }

        @media (max-width: 850px) {
            .order-summary {
                position: relative;
            }

            .checkout-container {
                flex-direction: column;
            }

            .order-summary {
                width: 100%;
                top: 1rem;
            }

            .form-row {
                flex-direction: column;
            }

            .Modal-Body {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .checkout-container {
                margin: 0px;
                flex-direction: column-reverse;
            }

            .order-summary {
                top: 0rem;
                border-radius: 0px;
            }

            .form-section {
                border-radius: 0px;
            }
        }

        /* Estilos para el input de teléfono */
        .intl-tel-input {
            width: 100%;
            margin-bottom: 15px;
        }

        .intl-tel-input .selected-flag {
            background: #f8f9fa;
            border-radius: 5px 0 0 5px;
            padding: 0 8px;
        }

        .intl-tel-input input {
            padding-left: 60px !important;
            height: 45px;
            border: 1px solid #ced4da;
            border-radius: 0 5px 5px 0;
        }

        .intl-tel-input .country-list {
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .iti {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .iti--separate-dial-code .iti__selected-flag {
    border-radius: 12px 0px 0px 12px;
}

        /* Estilo para inputs con contenido */
        .input-has-content {
            background-color: rgb(52 161 30 / 6%);
            border-color: var(--secondary);
            transition: all 0.3s ease;
        }

        .form-control {
            transition: all 0.3s ease;
        }

        /* Agregar esto al estilo existente */
.form-control.input-has-content {
    background-color: rgba(92, 197, 40, 0.1) !important;
    border-color: var(--secondary) !important;
}

/* Asegurar que los selects también tengan el estilo */
select.form-control.input-has-content {
    background-color: rgba(92, 197, 40, 0.1) !important;
    border-color: var(--secondary) !important;
}
    </style>
</head>

<body>
    <div class="container">
        <div class="checkout-container">
            <!-- Formulario -->
            <div class="form-section">
                <div class="Modal-Title">
                    <h3>Finalizar Pedido</h3>
                </div>

                <form id="orderForm">
                    <h2 style="display: inline-flex;align-items: center;width: 100%;">Información del Remitente <img
                            src="./img/Bandera_USA_1.png" style="height: 24px;margin: 0px 5px;"></h2>

                    <div class="form-group">
                        <label for="senderName">Nombre Completo:</label>
                        <input type="text" id="senderName" class="form-control" placeholder="Nombre y Apellido"
                            required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="senderEmail">Correo Electrónico:</label>
                            <input type="email" id="senderEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="senderPhone">Número de Teléfono:</label>
                            <input type="tel" id="senderPhone" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="color: #5cc528;">Dirección Completa (USA):</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="senderStreet">Dirección:</label>
                                <input type="text" id="senderStreet" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="senderApt">Apt/Suite (opcional):</label>
                                <input type="text" id="senderApt" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="senderCity">Ciudad:</label>
                                <input type="text" id="senderCity" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="senderState">Estado:</label>
                                <select id="senderState" class="form-control" required>
                                    <option value="" disabled selected>Seleccione un estado</option>
                                    <!-- Los estados se cargarán dinámicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="senderZipCode">Código Postal:</label>
                                <input type="text" id="senderZipCode" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="pickupDate">Fecha de Recogida:</label>
                                <input type="date" id="pickupDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="pickupTime">Hora de Recogida:</label>
                                <select id="pickupTime" class="form-control" required>
                                    <option value="" disabled selected>Seleccione una hora</option>
                                    <!-- Las opciones se llenarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <h2 style="display: inline-flex;align-items: center;width: 100%;">Información del Destinatario <img
                            src="./img/Bandera_RD_1.png" style="height: 24px;margin: 0px 5px;"></h2>

                    <div class="form-group">
                        <label for="receiverName">Nombre Completo:</label>
                        <input type="text" id="receiverName" class="form-control" placeholder="Nombre y Apellido"
                            required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiverPhone">Teléfono del Destinatario:</label>
                            <input type="tel" id="receiverPhone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="receiverCedula">Cédula del Destinatario:</label>
                            <input type="text" id="receiverCedula" class="form-control" placeholder="000-0000000-0"
                                required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="receiverProvince">Provincia:</label>
                        <select id="receiverProvince" class="form-control" required>
                            <option value="" disabled selected>Seleccione una provincia</option>
                            <option value="Distrito Nacional">Distrito Nacional</option>
                            <option value="Santo Domingo">Santo Domingo</option>
                            <option value="Santiago">Santiago</option>
                            <option disabled>──────────</option>
                            <option value="Azua">Azua</option>
                            <option value="Bahoruco">Bahoruco</option>
                            <option value="Barahona">Barahona</option>
                            <option value="Dajabón">Dajabón</option>
                            <option value="Duarte">Duarte</option>
                            <option value="El Seibo">El Seibo</option>
                            <option value="Elías Piña">Elías Piña</option>
                            <option value="Espaillat">Espaillat</option>
                            <option value="Hato Mayor">Hato Mayor</option>
                            <option value="Hermanas Mirabal">Hermanas Mirabal</option>
                            <option value="Independencia">Independencia</option>
                            <option value="La Altagracia">La Altagracia</option>
                            <option value="La Romana">La Romana</option>
                            <option value="La Vega">La Vega</option>
                            <option value="María Trinidad Sánchez">María Trinidad Sánchez</option>
                            <option value="Monseñor Nouel">Monseñor Nouel</option>
                            <option value="Monte Cristi">Monte Cristi</option>
                            <option value="Monte Plata">Monte Plata</option>
                            <option value="Pedernales">Pedernales</option>
                            <option value="Peravia">Peravia</option>
                            <option value="Puerto Plata">Puerto Plata</option>
                            <option value="Samaná">Samaná</option>
                            <option value="San Cristóbal">San Cristóbal</option>
                            <option value="San José de Ocoa">San José de Ocoa</option>
                            <option value="San Juan">San Juan</option>
                            <option value="San Pedro de Macorís">San Pedro de Macorís</option>
                            <option value="Sánchez Ramírez">Sánchez Ramírez</option>
                            <option value="Santiago Rodríguez">Santiago Rodríguez</option>
                            <option value="Valverde">Valverde</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="receiverAddress">Dirección Completa (RD):</label>
                        <input type="text" id="receiverAddress" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="additionalNotes">Notas adicionales (opcional):</label>
                        <textarea id="additionalNotes" class="form-control" rows="3"></textarea>
                    </div>

                    <!-- Elementos de Stripe para el formulario de tarjeta -->
                    <div id="stripeCardElement">
                        <div class="form-group">
                            <label for="card-element">Información de la Tarjeta:</label>
                            <div id="card-element" class="form-control"></div>
                            <div id="card-errors" role="alert"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn" id="submitOrderBtn">Confirmar Pedido</button>
                </form>

                <div id="successMessage" class="success-message" style="display: none;">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>¡Pedido Confirmado!</h2>
                    <p id="orderConfirmationText">Hemos recibido tu pedido correctamente. Nos pondremos en contacto
                        contigo para brindarte los detalles de seguimiento.</p>
                    <p style="font-weight: 600; margin: 1rem 0;"><span style="color: var(--primary);">Número de
                            Orden:</span> <span id="orderIdDisplay" style="color: var(--secondary);"></span></p>
                    <a href="index.html" class="btn" style="margin-top: 1rem;">Volver al Inicio</a>
                </div>
            </div>

            <!-- Resumen del Pedido -->
            <div class="order-summary">
                <div class="Modal-Title">
                    <h3>Resumen del Pedido</h3>
                </div>

                <div class="Modal-Body">
                    <div id="orderItemContainer"></div>
                    <div class="order-total">
                        <span>Total:</span>
                        <span id="orderTotal"></span>
                    </div>

                    <div class="payment-options">
                        <h2>Método de Pago</h2>

                        <div class="payment-option" onclick="selectPayment('online')">
                            <input type="radio" id="onlinePayment" name="payment" value="online" checked>
                            <div class="payment-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-label">
                                <label for="onlinePayment">Pagar en línea</label>
                                <p style="font-size: 0.9rem; color: #666;">Tarjeta de crédito/débito</p>
                            </div>
                        </div>

                        <div class="payment-option" onclick="selectPayment('pickup')">
                            <input type="radio" id="pickupPayment" name="payment" value="pickup">
                            <div class="payment-icon">
                                <i class="fas fa-box-open"></i>
                            </div>
                            <div class="payment-label">
                                <label for="pickupPayment">Pagar al recoger</label>
                                <p style="font-size: 0.9rem; color: #666;">Paga cuando se vaya a recoger tu envío</p>
                            </div>
                        </div>

                        <div class="payment-option" onclick="selectPayment('delivery')">
                            <input type="radio" id="deliveryPayment" name="payment" value="delivery">
                            <div class="payment-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="payment-label">
                                <label for="deliveryPayment">Pagar al recibir (RD)</label>
                                <p style="font-size: 0.9rem; color: #666;">Paga en efectivo cuando recibas tu envío</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUPUM36QOLPGb-FmPx6-qMZoS2pCZdurI",
            authDomain: "meetransportation.firebaseapp.com",
            projectId: "meetransportation",
            storageBucket: "meetransportation.appspot.com",
            messagingSenderId: "1087042032724",
            appId: "1:1087042032724:web:0975e57ca30ff342f349c1",
            measurementId: "G-8XHXKXL0CV"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const functions = firebase.functions();

        // Variables globales para Stripe
        let stripe, elements;

        // Función para cargar estados
        function loadStates(countryCode, targetSelectId) {
            const stateSelect = document.getElementById(targetSelectId);
            stateSelect.innerHTML = '<option value="" disabled selected>Seleccione un estado/provincia</option>';

            const states = {
                US: [
                    'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware',
                    'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky',
                    'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi',
                    'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico',
                    'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania',
                    'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
                    'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'
                ]
            };

            if (countryCode && states[countryCode]) {
                states[countryCode].forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
            }

    stateSelect.addEventListener('change', function() {
        checkInputContent();
        if (this.value === "") {
            this.classList.remove('input-has-content');
        } else {
            this.classList.add('input-has-content');
        }
    });
}

        // Seleccionar método de pago
        function selectPayment(method) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('payment-selected');
            });

            document.querySelector(`.payment-option[onclick="selectPayment('${method}')"]`).classList.add('payment-selected');
            document.querySelector(`#${method}Payment`).checked = true;

            const stripeCardElement = document.getElementById('stripeCardElement');
            if (method === 'online') {
                stripeCardElement.style.display = 'block';
                initializeStripeElements();
            } else {
                stripeCardElement.style.display = 'none';
            }
        }

        // Inicializar elementos de Stripe
        function initializeStripeElements() {
            if (!stripe) {
                stripe = Stripe('pk_test_51RflpxCQmmVrpuF3gY491FnR6XzcJuLSdXq4EqT3mkqWz3wA2Eu65yq6n2UFamVhkz0dsjJ7PcDvM7PevyTGtVWJ005zxlytKb');
                elements = stripe.elements();

                const card = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': {
                                color: '#aab7c4'
                            }
                        },
                        invalid: {
                            color: '#fa755a',
                            iconColor: '#fa755a'
                        }
                    }
                });

                card.mount('#card-element');

                card.addEventListener('change', function (event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            }
        }

        // Función para generar ID único
        async function generateId(prefix = 'mt') {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const datePart = year + month + day;

            const counterRef = db.collection('counters').doc('orders');

            return db.runTransaction(async (transaction) => {
                const doc = await transaction.get(counterRef);

                if (doc.exists) {
                    const data = doc.data();
                    let { lastLetter, lastNumber, lastDate } = data;

                    if (lastDate !== datePart) {
                        lastLetter = 'a';
                        lastNumber = 1;
                        lastDate = datePart;
                    } else {
                        lastNumber++;
                        if (lastNumber > 99) {
                            lastNumber = 1;
                            lastLetter = String.fromCharCode(lastLetter.charCodeAt(0) + 1);
                            if (lastLetter > 'z') lastLetter = 'a';
                        }
                    }

                    transaction.update(counterRef, {
                        lastLetter,
                        lastNumber,
                        lastDate
                    });

                    return `${prefix}${datePart}${lastLetter}${String(lastNumber).padStart(2, '0')}`;
                }

                transaction.set(counterRef, {
                    lastLetter: 'a',
                    lastNumber: 1,
                    lastDate: datePart
                });

                return `${prefix}${datePart}a01`;
            });
        }

        // Verificar inputs con contenido
function checkInputContent() {
    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
        if (input.tagName === 'SELECT') {
            input.classList.toggle('input-has-content', input.value !== '');
        } else {
            input.classList.toggle('input-has-content', input.value.trim() !== '');
        }
    });
}

        document.addEventListener('DOMContentLoaded', function () {
            // Configuración inicial
            loadStates('US', 'senderState');
            generateTimeOptions();
            setupEventListeners();
            selectPayment('online');
            checkInputContent();
        });

function generateTimeOptions() {
  const pickupTimeSelect = document.getElementById('pickupTime');
  pickupTimeSelect.innerHTML =
    '<option value="" disabled selected>Seleccione una hora</option>';

  const today = new Date();
  const currentHour = today.getHours();

  // «YYYY‑MM‑DD» seleccionado en el input
  const selectedDateValue = document.getElementById('pickupDate').value;
  // «YYYY‑MM‑DD» de la fecha actual en tu zona horaria
  const todayValue = today.toISOString().split('T')[0];

  const isToday = selectedDateValue === todayValue;

  for (let hour = 8; hour <= 21; hour++) {
    // Si no se ha escogido fecha, o la fecha no es hoy,
    // o la hora está en el futuro (si es hoy) → mostrarla
    if (!selectedDateValue || !isToday || hour > currentHour) {
      const formatted = `${hour.toString().padStart(2, '0')}:00`;
      const option = document.createElement('option');
      option.value = formatted;
      option.textContent = formatted;
      pickupTimeSelect.appendChild(option);
    }
  }
}


        function setupEventListeners() {
            document.getElementById('additionalNotes').addEventListener('input', checkInputContent);

            // Formatear cédula
            document.getElementById('receiverCedula').addEventListener('input', function (e) {
                let value = this.value.replace(/\D/g, '');
                let formatted = value.substring(0, 3);
                if (value.length > 3) formatted += '-' + value.substring(3, 10);
                if (value.length > 10) formatted += '-' + value.substring(10, 11);
                this.value = formatted;
            });

                // Agregar event listeners para cambios en los inputs
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', checkInputContent);
        input.addEventListener('change', checkInputContent);
    });
    
            // Validar fecha y hora
            const pickupDateInput = document.getElementById('pickupDate');
            pickupDateInput.setAttribute('min', new Date().toISOString().split('T')[0]);
            pickupDateInput.addEventListener('change', generateTimeOptions);

            // Configurar inputs de teléfono
            setupPhoneInput('senderPhone', 'us');
            setupPhoneInput('receiverPhone', 'do');

            // Cargar servicio seleccionado
            loadSelectedService();

            // Configurar autenticación
            auth.onAuthStateChanged(loadUserData);

            // Manejar envío del formulario
            document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
        }

        function setupPhoneInput(id, defaultCountry) {
            const input = document.getElementById(id);
            window[`${id}Iti`] = window.intlTelInput(input, {
                preferredCountries: [defaultCountry, defaultCountry === 'us' ? 'do' : 'us'],
                separateDialCode: true,
                initialCountry: defaultCountry,
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });

            input.addEventListener('input', function () {
                let value = this.value.replace(/\D/g, '');
                let formatted = value.substring(0, 3);
                if (value.length > 3) formatted += '-' + value.substring(3, 6);
                if (value.length > 6) formatted += '-' + value.substring(6, 10);
                this.value = formatted;
            });
        }

        // Función para cargar servicio seleccionado con soporte para carrito
        function loadSelectedService() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const selectedService = JSON.parse(localStorage.getItem('selectedService') || null);

            // Limpiar selectedService si no se usa
            if (selectedService) {
                localStorage.removeItem('selectedService');
            }

            if (cart.length === 0 && !selectedService) {
                window.location.href = 'index.html';
                return;
            }

            orderItemContainer.innerHTML = '';

            // Si hay items en el carrito, mostrarlos todos
            if (cart.length > 0) {
                let total = 0;

                cart.forEach((item, index) => {
                    const isPromo = item.type === 'promo';
                    const priceValue = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
                    const itemTotal = priceValue * (item.quantity || 1);
                    total += itemTotal;

                    const priceHtml = isPromo ?
                        item.price :
                        `US$${priceValue.toFixed(2)}`;

                    const itemElement = document.createElement('div');
                    itemElement.className = `order-item ${isPromo ? 'promo-summary' : ''}`;
                    itemElement.innerHTML = `
                ${item.icon ? `<img src="${item.icon}" alt="${item.name}">` : ''}
                <div class="order-details">
                    <div class="order-title">${item.name}</div>
                    ${!isPromo ? `
                    <div>
                        ${['slot1', 'slot2', 'slot3', 'slot4']
                                .filter(slot => item[slot])
                                .map(slot => `<p><strong>${item[slot].split(':')[0]}:</strong> 
                            ${item[slot].split(':').slice(1).join(':')}</p>`)
                                .join('')}
                    </div>` : ''}
                    <div class="order-price">
                        <span>Precio:</span>
                        <span>${priceHtml}</span>
                    </div>
                    <div style="display: inline-flex;width: 100%;align-items: center;justify-content: space-between;font-weight: bold;">
                    <div>Subtotal:</div>
                    <div style="text-align: right; margin-top: 5px;"><strong>US$${itemTotal.toFixed(2)}</strong></div>
                    </div>

                    <div id="box-counter">
                        <button onclick="updateQuantity(${index}, -1)">-</button>
                       <span style="margin: 0 6px;background: #dbdbdb;padding: 0 1rem;border-radius: 7px;">${item.quantity || 1}</span>
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                        <button onclick="removeItem(${index})" style="background: none; border: none; color: var(--accent); margin-left: 7px; cursor: pointer;font-size: 1.1rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                </div>
            `;

                    orderItemContainer.appendChild(itemElement);
                });

                document.getElementById('orderTotal').textContent = `US$${total.toFixed(2)}`;
            }
            // Si no hay carrito pero hay un servicio seleccionado
            else if (selectedService) {
                const isPromo = selectedService.type === 'promo';
                const priceValue = parseFloat(selectedService.price.replace(/[^\d.]/g, '')) || 0;
                const priceHtml = isPromo ?
                    selectedService.price :
                    `US$${priceValue.toFixed(2)}`;

                orderItemContainer.innerHTML = `
            <div class="order-item ${isPromo ? 'promo-summary' : ''}">
                ${selectedService.icon ? `<img src="${selectedService.icon}" alt="${selectedService.name}">` : ''}
                <div class="order-details">
                    <div class="order-title">${selectedService.name}</div>
                    ${!isPromo ? `
                    <div>
                        ${['slot1', 'slot2', 'slot3', 'slot4']
                            .filter(slot => selectedService[slot])
                            .map(slot => `<p><strong>${selectedService[slot].split(':')[0]}:</strong> 
                            ${selectedService[slot].split(':').slice(1).join(':')}</p>`)
                            .join('')}
                    </div>` : ''}
                    <div class="order-price">
                        <span>Precio:</span>
                        <span>${priceHtml}</span>
                    </div>
                    <div style="text-align: right; margin-top: 10px;">
                        <strong>Total: US$${priceValue.toFixed(2)}</strong>
                    </div>
                </div>
            </div>
        `;

                document.getElementById('orderTotal').textContent =
                    isPromo && selectedService.price.includes('US$') ?
                        selectedService.price :
                        `US$${selectedService.price}`;
            }
        }


        // Función para actualizar la cantidad de un artículo
        function updateQuantity(index, change) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (index >= 0 && index < cart.length) {
                // Prevenir que la cantidad sea menor que 1
                if ((cart[index].quantity || 1) + change < 1) {
                    return; // Simplemente no hacer nada
                }

                cart[index].quantity = (cart[index].quantity || 1) + change;

                // Actualizar el carrito y recargar la vista
                localStorage.setItem('cart', JSON.stringify(cart));
                loadSelectedService();
            }
        }


        // Función para eliminar un artículo del carrito
        function removeItem(index) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            if (index >= 0 && index < cart.length) {
                cart.splice(index, 1);

                // Actualizar el carrito y recargar la vista
                localStorage.setItem('cart', JSON.stringify(cart));
                loadSelectedService();

                // Si el carrito queda vacío, redirigir al inicio
                if (cart.length === 0) {
                    window.location.href = 'index.html';
                }
            }
        }


async function loadUserData(user) {
    if (!user) return;

    const doc = await db.collection('users').doc(user.uid).get();
    if (!doc.exists) return;

    const userData = doc.data();
    
    // Autocompletar campos básicos
    document.getElementById('senderName').value = userData.profile?.name || '';
    document.getElementById('senderEmail').value = user.email;

    // Autocompletar teléfono
    if (userData.profile?.phone) {
        const phoneInput = document.getElementById('senderPhone');
        phoneInput.value = userData.profile.phone;
        if (window.senderPhoneIti) {
            window.senderPhoneIti.setNumber(userData.profile.phone);
        }
    }

    // Autocompletar dirección
    if (userData.profile?.address) {
        const { street, city, zipCode, state } = userData.profile.address;
        document.getElementById('senderStreet').value = street || '';
        document.getElementById('senderCity').value = city || '';
        document.getElementById('senderZipCode').value = zipCode || '';
        
        if (state) {
            // Usar requestAnimationFrame para sincronizar con el ciclo de renderizado
            requestAnimationFrame(() => {
                document.getElementById('senderState').value = state;
                checkInputContent();
            });
        }
    }
    
    // Verificación final con pequeño retraso para asegurar que todos los campos estén listos
    setTimeout(() => {
        checkInputContent();
        // Forzar una segunda verificación por si acaso
        requestAnimationFrame(checkInputContent);
    }, 300);
}

async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitOrderBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    submitBtn.disabled = true;

    if (!validateForm()) {
        submitBtn.textContent = 'Confirmar Pedido';
        submitBtn.disabled = false;
        return;
    }

    try {
        const orderId = await generateId('mt');
        const orderData = await prepareOrderData(orderId);

        // Guardar siempre en la colección principal
        await db.collection('orders').doc(orderId).set(orderData);

        // Solo guardar en userOrders si hay usuario autenticado
        if (auth.currentUser) {
            await saveUserOrder(auth.currentUser.uid, orderId, orderData);
        }

        await processPayment(orderData, orderId);
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    } finally {
        submitBtn.textContent = 'Confirmar Pedido';
        submitBtn.disabled = false;
    }
}

        function validateForm() {
            let isValid = true;
            const requiredFields = [
                'senderName', 'senderEmail', 'senderPhone', 'senderStreet',
                'senderCity', 'senderState', 'senderZipCode',
                'receiverName', 'receiverPhone', 'receiverCedula',
                'receiverAddress', 'receiverProvince',
                'pickupDate', 'pickupTime'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    isValid = false;
                } else {
                    field.style.borderColor = '#ddd';
                }
            });

            if (!isValid) {
                alert('Por favor complete todos los campos requeridos');
                return false;
            }
            return true;
        }

        // Función para preparar datos del pedido
      async function prepareOrderData(orderId) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    let services = [];
    let totalPrice = 0;

    services = cart.map(item => {
        const priceValue = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
        totalPrice += priceValue * (item.quantity || 1);

        return {
            id: item.id,
            name: item.name,
            price: item.price,
            numericPrice: priceValue,
            type: item.type,
            icon: item.icon || null,
            quantity: item.quantity || 1
        };
    });

    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    const paymentStatus = paymentMethod === 'online' ? 'paid' : 'pending';

    return {
        id: orderId,
        services: services,
        totalPrice: totalPrice,
        sender: await getSenderData(),
        receiver: await getReceiverData(),
        paymentMethod: paymentMethod,
        paymentStatus: paymentStatus, // Nuevo campo
        additionalNotes: document.getElementById('additionalNotes').value.trim(),
        status: 'order-pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        userId: auth.currentUser?.uid || null
    };
}

        async function getSenderData() {
            const phone = await getFormattedPhone('senderPhone');

            return {
                name: document.getElementById('senderName').value.trim(),
                email: document.getElementById('senderEmail').value.trim(),
                phone: phone,
                address: {
                    street: document.getElementById('senderStreet').value.trim(),
                    apt: document.getElementById('senderApt').value.trim(),
                    city: document.getElementById('senderCity').value.trim(),
                    state: document.getElementById('senderState').value,
                    zipCode: document.getElementById('senderZipCode').value.trim(),
                    country: 'US'
                },
                pickupDateTime: {
                    date: document.getElementById('pickupDate').value,
                    time: document.getElementById('pickupTime').value
                }
            };
        }

        async function getReceiverData() {
            const phone = await getFormattedPhone('receiverPhone');

            return {
                name: document.getElementById('receiverName').value.trim(),
                phone: phone,
                cedula: document.getElementById('receiverCedula').value.trim(),
                address: document.getElementById('receiverAddress').value.trim(),
                province: document.getElementById('receiverProvince').value,
                country: 'DO'
            };
        }

        async function getFormattedPhone(inputId) {
            const input = document.getElementById(inputId);
            let phoneNumber = '';

            if (window[`${inputId}Iti`]) {
                phoneNumber = window[`${inputId}Iti`].getNumber(intlTelInputUtils.numberFormat.E164);
                phoneNumber = phoneNumber.replace(/[-\s]/g, '');
            } else {
                phoneNumber = input.value.replace(/[-\s]/g, '');
                if (!phoneNumber.startsWith('+')) {
                    phoneNumber = '+1' + phoneNumber;
                }
            }

            return phoneNumber;
        }

        async function saveUserOrder(userId, orderId, orderData) {
            await db.collection('users').doc(userId).collection('userOrders').doc(orderId).set({
                orderId: orderId,
                timestamp: orderData.timestamp,
                status: 'order-pending',
                serviceName: orderData.services.length === 1 ? orderData.services[0].name : 'Múltiples servicios',
                servicePrice: orderData.totalPrice,
                 paymentStatus: orderData.paymentStatus,
            paymentMethod: orderData.paymentMethod,
            services: orderData.services,
            totalPrice: orderData.totalPrice,
            sender: orderData.sender,
            receiver: orderData.receiver,
            additionalNotes: orderData.additionalNotes,
                pickupDate: orderData.sender.pickupDateTime.date,
                pickupTime: orderData.sender.pickupDateTime.time
            });
        }

        // Función para procesar pago
        async function processPayment(orderData, orderId) {
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

            if (paymentMethod !== 'online') {
                localStorage.setItem('lastOrderId', orderId);
                localStorage.removeItem('cart');
                window.location.href = 'order-complete.html';
                return;
            }

            if (!stripe || !elements) {
                throw new Error('El sistema de pago no está listo. Por favor recarga la página.');
            }

            try {
                const createPaymentFunction = firebase.functions().httpsCallable('createStripePaymentIntent');
                const result = await createPaymentFunction({
                    amount: orderData.totalPrice * 100,
                    currency: 'usd',
                    metadata: {
                        orderId: orderId,
                        serviceCount: orderData.services.length
                    }
                });

                const { clientSecret } = result.data;
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: elements.getElement('card'),
                        billing_details: {
                            name: orderData.sender.name,
                            email: orderData.sender.email,
                            phone: orderData.sender.phone,
                            address: {
                                line1: orderData.sender.address.street,
                                line2: orderData.sender.address.apt,
                                city: orderData.sender.address.city,
                                state: orderData.sender.address.state,
                                postal_code: orderData.sender.address.zipCode,
                                country: 'US'
                            }
                        }
                    }
                });

                if (error) throw error;

                await db.collection('orders').doc(orderId).update({
                    status: 'payment-completed',
                    paymentStatus: 'paid',
                    paymentDate: firebase.firestore.FieldValue.serverTimestamp(),
                    stripePaymentId: paymentIntent.id
                });

                if (auth.currentUser) {
                    await db.collection('users').doc(auth.currentUser.uid).collection('userOrders').doc(orderId).update({
                        status: 'payment-completed',
                        paymentStatus: 'paid'
                    });
                }

                localStorage.setItem('lastOrderId', orderId);
                localStorage.removeItem('cart');
                window.location.href = `order-complete.html?payment_intent_client_secret=${clientSecret}`;
            } catch (error) {
                console.error('Error en el pago:', error);
                document.getElementById('card-errors').textContent = error.message;
                throw error;
            }
        }
    </script>
</body>

</html>